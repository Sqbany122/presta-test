var sensbitdpd=function(r,e,a){var n={id_order:"",ajax_url_packages:"",next_package_id:1,google_key:"AIzaSyDZc6Ajf0PqhUAzbktozQyHFpi5V7TZW_o",callback_queue:{}};function c(e){var n={};return e.find(".param").each(function(e,a){var t="";t=r(this).is(":checkbox")?r(this).is(":checked")?1:0:r(this).val(),n[r(this).attr("name")]=t}),n}function i(e,a,t,n){n=void 0!==n&&n;e.parents(".messages-container");var i=e.find(".message");i.removeClass("success warning danger").addClass(t),i.html(a),i.fadeIn(),n&&setTimeout(function(){i.fadeOut()},1e3),r(".sensbitdpd .messages-container .message").each(function(){var e=r(this),a=e.parents("tr"),t=e.parents(".messages-container");e.css("top",a.offset().top-t.offset().top),e.css("height",a.height()),e.css("line-height",a.height()+"px")})}function d(){var e=r(".sensbitdpd-orders-selected-container");if(e.length){var a=r(".sensbitdpd .package input[name='checked']:checked").length;r(".sensbitdpd .package.error input[name='checked']:checked").length?(e.find(".prepare-packs").hide(),e.find(".next-error").fadeIn().css("display","block")):(e.find(".next-error").hide(),e.find(".prepare-packs").fadeIn().css("display","block")),e.find(".n").text(a),0<a?e.css("top","0px"):e.removeAttr("style")}}r(function(){r(document).ajaxSuccess(function(e,a,t){!function(e,a){if(void 0!==a.url&&0<=a.url.toLowerCase().search(n.module)){try{void 0===e.responseJSON&&(e.responseJSON=JSON.parse(e.responseText))}catch(e){}void 0!==e.responseJSON&&void 0!==e.responseJSON.callback&&r(e.responseJSON.callback).each(function(e,a){for(var t in a)void 0===n.callback_queue[t]&&(n.callback_queue[t]=[]),n.callback_queue[t].push(a[t])})}}(a,t)}),setInterval(function(){if(0==r.active){for(var e in n.callback_queue)"function"==typeof window[n.module][e]&&window[n.module][e].apply(null,[r.unique(n.callback_queue[e])]);n.callback_queue={}}},1e3),r.fn.tooltip&&(r(".sensbitdpd-tip").each(function(){void 0!==r(this).attr("placeholder")&&r(this).attr("title",r(this).attr("placeholder"))}),r(".sensbitdpd-tip").tooltip({html:!0})),r.fn.datetimepicker?r(".sensbitdpd-datetime").datetimepicker({prevText:"",nextText:"",dateFormat:"yy-mm-dd",timeFormat:"hh:mm:ss"}):r.fn.datepicker&&r(".sensbitdpd-datetime").datepicker({prevText:"",nextText:"",dateFormat:"yy-mm-dd",timeFormat:"hh:mm:ss"}),r("#sensbitdpd_pickup_sender_point").on("change",function(){p.checkPredefinedPlace()}),r("#sensbitdpd_pickup_sender_point").trigger("change"),r(".sensbitdpd-service").on("click",function(e){e.preventDefault(),p.createServicePackage(r(this).data("id"))});var e=r(".sensbitdpd-pack-status[data-autocheck=1]").map(function(){return r(this).data("id-shipment")}).get();0<e.length&&p.getPackStatus(e),r(document).on("change",".sensbitdpd .package input[name='checked']",d),r(".sensbitdpd-service-order-select").on("change",function(e){r(".sensbitdpd-service-order-btn[data-id_order="+r(this).data("id_order")+"]").data("id_template",r(this).val())}),r(".sensbitdpd-service-order-btn").on("click",function(e){e.preventDefault(),p.createServiceOrderPackage(r(this).data("id_order"),r(this).data("id_template"))}),r(".sensbitdpd-orders-selected-container .next-error").on("click",function(e){r("html, body").animate({scrollTop:r(".sensbitdpd .package.error").eq(0).offset().top-150},500)}),r(".sensbitdpd-mass-open").on("click",function(e){e.preventDefault(),r(".sensbitdpd-service-order-btn").trigger("click")}),r(".sensbitdpd-mass-add").on("click",function(e){e.preventDefault(),r(".sensbitdpd-service-order-btn").trigger("click");var a=setInterval(function(){r.active<=0&&(r(".sensbitdpd .prepare-packs").trigger("click"),clearInterval(a))},500)}),r(".sensbitdpd .prepare-packs").on("click",function(e){e.preventDefault(),r(".sensbitdpd .package-options").hide(),p.addSelectedPackages()}),r(".sensbitdpd .print-labels").on("click",function(e){e.preventDefault();var a=[];r(".sensbitdpd .completed-packs:checked").each(function(){a.push(r(this).val())}),p.printLabels(a)}),r(".sensbitdpd-bulk-labels").on("click",function(e){e.preventDefault();var a=[];r(".sensbitdpd_shipment input:checked").each(function(){a.push(r(this).val())}),p.printLabels(a)}),r(".sensbitdpd-bulk-protocol").on("click",function(e){e.preventDefault();var a=[];r(".sensbitdpd_shipment input:checked").each(function(){a.push(r(this).val())}),p.printProtocol(a)}),r(".sensbitdpd-bulk-change-order-state-by-packages_open-panel").on("click",function(e){e.preventDefault(),r(".sensbitdpd-bulk-change-order-state-by-packages_panel").slideToggle()}),r(".sensbitdpd-bulk-change-order-state-by-packages_do").on("click",function(e){e.preventDefault();var a=r(".sensbitdpd-bulk-change-order-state-by-packages_id-order-state").val(),t=[];r(".sensbitdpd_shipment input:checked").each(function(){t.push(r(this).val())}),p.changeOrderStateByPackages(this,t,a)}),r(".sensbitdpd .delete-shipments").on("click",function(e){e.preventDefault();var a=[];r(".sensbitdpd .completed-packs:checked").each(function(){a.push(r(this).val())}),p.deleteShipments(a)}),r(".sensbitdpd .messages-container .message").on("click",function(){r(this).closest(".package").removeClass("error"),r(this).fadeOut()}),r(".sensbitdpd-orders-filters-open").on("click",function(e){e.preventDefault();var a=r(".sensbitdpd-orders-filters .filters-container");a.toggleClass("open"),a.hasClass("open")?r(this).text("Zwiń ⇈"):r(this).text("Rozwiń ⇊")}),r(".sensbitdpd .switch_global_templates").on("click",function(e){e.preventDefault(),r(this).closest(".sensbitdpd").toggleClass("hide_global_templates")}),r(".sensbitdpd .switch_no_templates").on("click",function(e){e.preventDefault(),r(this).closest(".sensbitdpd").toggleClass("hide_no_templates")}),r(document).on("click",".sensbitdpd-slide-toggle",function(e){e.preventDefault();var a=r(this),t=a.attr("href");r(t).length&&r(t).slideToggle(400,function(){r(t).is(":visible")?a.html("Ukryj"):a.html("Pokaż")})})});var p={setOptions:function(e){r.extend(n,e)},setIdOrder:function(e){this.id_order=e},showAlert:function(e){r.prototype.fancybox?r.fancybox.open([{type:"inline",autoScale:!0,minHeight:30,content:'<p class="fancybox-error">'+e+"</p>"}],{padding:0,helpers:{overlay:{locked:!1}}}):alert(e)},bindEventsToPackage:function(e){var t=r(".sensbitdpd #package_"+e),a=r(".sensbitdpd #package_options_"+e);t.find(".param, .package-param").each(function(){r(this).attr("title",r(this).attr("placeholder"))}),a.find(".param, .package-param").each(function(){r(this).attr("title",r(this).attr("placeholder"))}),r.fn.tooltip&&(t.find(".param, .package-param").tooltip(),a.find(".param, .package-param").tooltip()),t.find(".edit-address").click(function(e){e.preventDefault(),$addr_text=r(this).closest(".address"),$addr_edit=$addr_text.next(".address-edit"),$addr_text.hide(),$addr_edit.fadeIn()}),t.find(".save-address").click(function(e){e.preventDefault(),$addr_edit=r(this).closest(".address-edit"),$addr_text=$addr_edit.prev(".address"),$addr_text.find("div").html([$addr_edit.find("input[name=company]").val(),$addr_edit.find("input[name=firstname]").val()+" "+$addr_edit.find("input[name=lastname]").val(),$addr_edit.find("input[name=street]").val()+" "+$addr_edit.find("input[name=building_number]").val(),$addr_edit.find("input[name=postcode]").val()+" "+$addr_edit.find("input[name=city]").val(),$addr_edit.find("input[name=country_iso_code]").val()].filter(function(e){return 0<e.length}).join("<br/>")),$addr_text.fadeIn(),$addr_edit.hide()}),t.find(".remove-package").click(function(e){e.preventDefault(),a.remove(),t.fadeOut(400,function(){t.closest("table").find(".package").length<=1&&(t.closest("table").hide(),t.closest(".packages-form").hide()),t.remove(),d()})}),t.find(".message").click(function(){t.removeClass("error"),r(this).fadeOut(),d()}),t.find(".show-options").on("click",function(e){e.preventDefault(),a.is(":visible")?(a.fadeOut(),t.removeClass("options-visible")):(a.fadeIn(),t.addClass("options-visible"))}),t.on("click",".copy",function(e){e.preventDefault(),r(this).closest(".subpackage").clone(!1).appendTo(t.find(".subpackages"));var a=1;t.find(".subpackage").each(function(){r(this).find(".number input").val(a++)}),r.fn.tooltip&&t.find(".subpackage .package-param").tooltip()}),t.on("click",".subpackage .remove",function(e){e.preventDefault(),r(this).closest(".subpackage").fadeOut(400,function(){r(this).remove();var e=1;t.find(".subpackage").each(function(){r(this).find(".number input").val(e++)})})})},openMap:function(e){},update:function(){r.ajax({type:"POST",data:{ajax:1,sensbitdpd:1,action:"update"},beforeSend:function(){showNoticeMessage("Aktualizacja bazy danych modułu DPD")},error:function(e,a,t){showErrorMessage(a)},success:function(e){void 0!==e.errors?showErrorMessage(e.errors.join(", ")):showSuccessMessage("Aktualizacja bazy danych modułu DPD przebiegła pomyślnie")}})},createServiceOrderPackage:function(i,e){var s=i+"_"+n.next_package_id,o=0<r("#sensbitdpd-order-form-"+i).length?0:1;r.ajax({type:"POST",url:n.ajax_url_packages,data:{ajax:1,action:"getNewPackageForm",id_template:e,id_order:i,uniq:s,full:o},beforeSend:function(){++n.next_package_id},success:function(e){if(o){var a=r(".sensbitdpd-service-order-select[data-id_order="+i+"]").closest("tr"),t=a.find("td").length,n=r("<tr><td colspan='"+t+" style='padding:0'></td></tr>");n.addClass(a.attr("class")),n.find("td").append(e),a.after(n)}else r("#sensbitdpd-order-form-"+i).fadeIn(),r("#sensbitdpd-order-form-"+i).find(".package-container").append(e);p.bindEventsToPackage(s),d()}})},createServicePackage:function(e){var a=n.id_order+"_"+n.next_package_id;r.ajax({type:"POST",url:n.ajax_url_packages,data:{ajax:1,action:"getNewPackageForm",id_template:e,id_order:n.id_order,uniq:a},beforeSend:function(){++n.next_package_id},success:function(e){r(".sensbitdpd .packages-form table:hidden").show(),r(".sensbitdpd .packages-form:hidden").fadeIn(),r(".sensbitdpd .package-container").append(e),p.bindEventsToPackage(a)}})},addSelectedPackages:function(){var o,e=(o=[],r(".sensbitdpd .package input[name='checked']:checked").each(function(e,a){var t=r(a).closest(".package"),n=r(".sensbitdpd #package_options_"+t.data("id")),i=c(t);r.extend(i,c(n));var s=[];t.find(".subpackage").each(function(){var e={};r(this).find("input[name]").each(function(){e[r(this).attr("name")]=r(this).val()}),s.push(e)}),r.extend(i,{subpackages:s}),o.push(i)}),o);e.length<=0?showAlert("Nie wybrano żadnych paczek"):r(e).each(function(){var e=this,a=r(".sensbitdpd #package_"+e.uniq),t=[];1==e.cod&&parseFloat(e.cod_value)<=0&&t.push("Nieprawidłowa kwota pobrania"),e.masa<=0&&t.push("Masa przesyłki jest nieprawidłowa."),parseInt(e.is_point)?e.id_point.length<=0&&t.push("Nie podano punktu odbioru przesyłki"):(e.firstname.length<=0&&t.push("Błędne imię odbiorcy"),e.lastname.length<=0&&t.push("Błędne nazwisko odbiorcy"),e.street.length<=0&&t.push("Nie podano ulicy odbiorcy"),0<e.validate_street_nbr&&e.building_number.length<=0&&t.push("Nie podano numeru budynku / mieszkania"),e.postcode.length<=0&&t.push("Kod pocztowy odbiorcy jest nieprawidłowy"),e.city.length<=0&&t.push("Błędne miasto odbiorcy"),2!==e.country_iso_code.length&&t.push("Błędny kod kraju odbiorcy. 2 znaki max.")),n.validate_fields_length&&("dpd_poland"==e.service||"dpd_pickup"==e.service?n.join_refs?81<e.reference.length+e.ref2.length+e.ref3.length&&t.push("Łączna długość opisu, pola ref2 i ref3 zawiera zbyt dużo znaków. Max 81. (tyle mieści się na etykiecie)."):(27<e.reference.length&&t.push("Pole opis przesyłki zawiera zbyt dużo znaków. Max 27. (tyle mieści się na etykiecie)."),27<e.ref2.length&&t.push("Pole ref2 przesyłki zawiera zbyt dużo znaków. Max 27. (tyle mieści się na etykiecie)."),27<e.ref3.length&&t.push("Pole ref3 przesyłki zawiera zbyt dużo znaków. Max 27. (tyle mieści się na etykiecie)."),r.each(e.subpackages,function(e,a){54<a.package_content.length&&t.push("Pole zawartość paczki nr "+(e+1)+"  zawiera zbyt dużo znaków. Max 54. (tyle mieści się na etykiecie)")})):"dpd_international"==e.service&&(n.join_refs&&72<e.reference.length+e.ref2.length?t.push("Łączna długość opisu i pola ref2 zawiera zbyt dużo znaków. Max 72. (tyle mieści się na etykiecie)."):(36<e.reference.length&&t.push("Pole opis przesyłki zawiera zbyt dużo znaków. Max 36. (tyle mieści się na etykiecie)."),36<e.ref2.length&&t.push("Pole ref2 przesyłki zawiera zbyt dużo znaków. Max 36. (tyle mieści się na etykiecie).")))),t.length?(a.addClass("error"),i(a,"Popraw następujące błędy: "+t.join(", "),"danger"),d()):r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"sendPackage",pack:e},beforeSend:function(e){a.removeClass("error"),i(a,"Trwa przygotowywanie przesyłki","warning")},success:function(e){void 0!==e.errors?(a.addClass("error"),i(a,e.errors.join(", "),"danger",!1),d()):void 0!==e.status&&"completed"==e.status&&(r(".sensbitdpd .packages-ready-form:hidden").fadeIn(),r(".sensbitdpd .packages-ready-container:hidden").fadeIn(),r(e.packs).each(function(){var e=this;r(".sensbitdpd .packages-ready-container").append(e.pack),void 0!==e.tracking_number&&(r(".sensbitdpd-shipment-list[data-id_order="+e.id_order+"]").append('<a class="sensbitdpd-tip" title="Pobiera etykietę dla przesyłki o nr '+e.tracking_number+'" href="#" style="color:#0c0;" onclick="sensbitdpd.printLabels('+e.id_shipment+');return false;">'+e.tracking_number+"</a>"),r.fn.tooltip&&r(".sensbitdpd-shipment-list .sensbitdpd-tip").tooltip())}),a.fadeOut(400,function(){a.closest("table").find(".package").length<=1&&(a.closest("table").hide(),a.closest(".packages-form").hide()),a.remove(),d()}))}})})},printLabels:function(e){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printLabels",id_shipment:e},beforeSend:function(e){showSuccessMessage("Generowanie etykiet")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.files,function(e,a){var t=n.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;r("<iframe></iframe>").hide().attr("src",t).appendTo(r("body")).load(function(){var e=this;setTimeout(function(){r(e).remove()},100)})})}})},printLabelsByProtocolId:function(e){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printLabelsByProtocolId",id_protocol:e},beforeSend:function(e){showSuccessMessage("Generowanie etykiet z protokołu")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.files,function(e,a){var t=n.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;r("<iframe></iframe>").hide().attr("src",t).appendTo(r("body")).load(function(){var e=this;setTimeout(function(){r(e).remove()},100)})})}})},printLabelsByDispatchId:function(e){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printLabelsByDispatchId",id_dispatch_order:e},beforeSend:function(e){showSuccessMessage("Generowanie etykiet z protokołu")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.files,function(e,a){var t=n.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;r("<iframe></iframe>").hide().attr("src",t).appendTo(r("body")).load(function(){var e=this;setTimeout(function(){r(e).remove()},100)})})}})},printProtocol:function(e){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printProtocol",id_shipment:e},beforeSend:function(e){showSuccessMessage("Generowanie protokołu")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.files,function(e,a){var t=n.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;r("<iframe></iframe>").hide().attr("src",t).appendTo(r("body")).load(function(){var e=this;setTimeout(function(){r(e).remove()},100)})})}})},printProtocolById:function(e){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printProtocolById",id_protocol:e},beforeSend:function(e){showSuccessMessage("Pobieranie protokołu")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.files,function(e,a){var t=n.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;r("<iframe></iframe>").hide().attr("src",t).appendTo(r("body")).load(function(){var e=this;setTimeout(function(){r(e).remove()},100)})})}})},printProtocolByDispatchId:function(e){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printProtocolByDispatchId",id_dispatch_order:e},beforeSend:function(e){showSuccessMessage("Generowanie protokołu")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.files,function(e,a){var t=n.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;r("<iframe></iframe>").hide().attr("src",t).appendTo(r("body")).load(function(){var e=this;setTimeout(function(){r(e).remove()},100)})})}})},getPackStatus:function(a){a instanceof Array||(a=[a]),r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getPackStatus",id_shipment:a},beforeSend:function(e){r.each(a,function(){r(".sensbitdpd-pack-status[data-id-shipment="+this+"]").removeClass("new old").addClass("check")})},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):r.each(e.data,function(e,a){var t=r(".sensbitdpd-pack-status[data-id-shipment="+e+"]"),n=t.text();void 0!==a.error?(t.text(a.status),t.removeClass("check new old").addClass("err")):n!==a.status?(t.text(a.status),t.removeClass("check old").addClass("new"),showSuccessMessage("Przesyłka "+a.tracking_number+" otrzymała nowy status: "+a.status)):t.removeClass("check new").addClass("old")})}})},deleteShipments:function(e){r.isArray(e)||(e=[e]),r(e).each(function(){var e=parseInt(this),a=r(".sensbitdpd #shipment_"+e);r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"deleteShipment",id_shipment:e},beforeSend:function(e){i(a,"Trwa usuwanie przesyłki","warning",!1)},success:function(e){void 0!==e.errors?i(a,e.errors.join(", "),"danger"):(i(a,"Przesyłka została usunięta z systemu","success"),a.find(".message").click(function(){a.fadeOut(400,function(){r(this).remove()})}))}})})},initSwitches:function(e){function i(){e.forEach(function(e){!function(e,a,t){a=parseInt(a)<=0?"":":lt("+a+")";var n=parseInt(r(e+":checked").val());if(""===a)var i=r(e).closest("div.form-group").not(".blocked").nextAll("div.form-group");else var i=r(e).closest("div.form-group").not(".blocked").nextAll(a);n===t?i.slideDown():i.slideUp()}(e[0],e[1],e[2])})}e=r.map(e,function(e){var a=e[0],t=e[1],n=e[2];return r("input[name="+a+"]").on("change",function(){i()}),[["input[name="+a+"]",t,n]]}),i()},checkPredefinedPlace:function(){var e=r("#sensbitdpd_pickup_sender_point :selected");if(e.length){var a=e.data("json");void 0!==a&&(r("input[name='pickupSender[senderName]'").css("opacity",0).val(a.company).animate({opacity:1},300),r("input[name='pickupSender[senderFullName]'").css("opacity",0).val(a.name).animate({opacity:1},300),r("input[name='pickupSender[senderAddress]'").css("opacity",0).val(a.address).animate({opacity:1},300),r("input[name='pickupSender[senderCity]'").css("opacity",0).val(a.city).animate({opacity:1},300),r("input[name='pickupSender[senderPostalCode]'").css("opacity",0).val(a.post_code).animate({opacity:1},300),r("input[name='pickupSender[senderPhone]'").css("opacity",0).val(a.phone).animate({opacity:1},300))}},updateShippingTable:function(e){var a=r("#shipping_table");a.length&&r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getShippingTable",id_order:e},beforeSend:function(e){showSuccessMessage("Aktualizowanie tabeli przewoźników")},success:function(e){void 0!==e.errors?p.showAlert(e.errors.join(", ")):void 0!==e.content&&(a.find("tbody").html(e.content),showSuccessMessage("Tabela przewoźników została zaktualizowana."))}})},changeOrderStateByPackages:function(a,e,t){r.ajax({type:"POST",url:n.ajax_url_packages,dataType:"json",data:{ajax:1,action:"changeOrderStateByPackages",id_shipment:e,id_order_state:t},beforeSend:function(e){showSuccessMessage("Zmiana statusów powiązanych zamówień."),r(a).prop("disabled",!0)},success:function(e){r(a).prop("disabled",!1),void 0!==e.errors?p.showAlert(e.errors.join(", ")):showSuccessMessage("Zmieniono statusy powiązanych zamówień.")}})}};return p}($,window,document);